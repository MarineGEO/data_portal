---
title: ""
output: 
  md_document: 
    variant: markdown
---

  <br />
  <br />

<img src="www/Logomark_MarineGEO_Tennenbaum_RGB.png" width="319" height="100"/>

  <br />
  <br />

## Data Submission Report
#### Report date: `r as.character(Sys.Date())`
#### Submitted by `r as.character(input$email)`
#### Synthesis status: `r report_status()`

This report documents whether the data submission passes MarineGEO's quality assurance/quality control tests. If your submission failed one of the tests, you can view which protocol and sheet failed the test. Please update your data to fix any issues based on this information. If you cannot determine how to interpret a result, modify your data, or believe your data should be able to pass the tests, email MarineGEO (marinegeo@si.edu). 

Once you've addressed any issues(s), resubmit ONLY the data associated with the failed submission. 

  <br />

### Map of Sampling Locations

```{r echo=FALSE, results='asis', warning=FALSE, message=FALSE}
# Plot all coords in protocol submission ##########

tryCatch({
  
if(nrow(submission_coords$all_coords) > 0){
  
  reshape_coords <- submission_coords$all_coords
  
  # # assign segment IDs 
  # df$segment_id <- seq(from = 1, to = nrow(df))
  # 
  # # split the coordinate pairs and rename the lat/lon
  # df1 <- df %>% select(protocol, site_code, segment_id, latitude_1, longitude_1) %>%
  #   rename(lat = latitude_1, lon = longitude_1)
  # 
  # df2 <- df %>% select(protocol, site_code, segment_id, latitude_2, longitude_2) %>%
  #   rename(lat = latitude_2, lon = longitude_2)
  # 
  # # bind the rows of coordinate pairs
  # reshape_coords <- rbind(df1, df2) %>%
  #   arrange(segment_id)
  
  if(is.numeric(reshape_coords$lat) | is.numeric(reshape_coords$lon)){
      ## Plot Coordinates ---------
  
  # load leaflet library
  library(leaflet)
  
  # define palette
  pal <- colorFactor(palette = "Set1",
                     reshape_coords$protocol)
  
  # base map of sampling points
  map <- leaflet(data = reshape_coords) %>%
    # addProviderTiles(providers$CartoDB) %>%
    addTiles() %>%
    addCircles(color = ~pal(protocol)) %>%
    addLegend(pal = pal, values = ~protocol)
  
  # add transect/trawl lines
  for(i in unique(reshape_coords$segment_id)){
    map <- addPolylines(map, data = reshape_coords[reshape_coords$segment_id == i,], 
                        lat = ~lat, lng = ~lon, group = ~segment_id)
  }
# print map to report
map
  } else {
    print("ERROR: Coordinate data is not in decimal degree format.")
  }
}
  },
    error = function(e){
      # current_protocol(submission_metadata$protocol[i])
      # original_filename_qa(submission_metadata$original_filename[i])

      # Create an error message in the QA result log
      QA_results$df <- setNames(as.data.frame("Error plotting sample coordinates."), "test") %>%
        mutate(column_name = NA,
               sheet_name = "sample_metadata",
               protocol = NA,
               filename = NA,
               values = NA,
               row_numbers = NA) %>%
        select(test, filename, protocol, sheet_name, column_name, row_numbers, values) %>%
        bind_rows(QA_results$df)
    })

```
  
  <br />

### QA/QC Test Results

If any files failed a QA test, the following table will describe which uploaded file, sheet, column, row, and value (if applicable) triggered the errors. You can read a description of each test in the section beneath the table. 

```{r echo=FALSE, results='asis'}
  
if(nrow(QA_results$df) > 0){
  report_warnings <- filter(warnings, title %in% QA_results$df$test)
  
  print(   
    kable(
      QA_results$df %>%
        select(test, filename, sheet_name, column_name, row_numbers, values) %>%
        distinct()
    )
  )
  
  cat("\n", "\n")
  
}



```

  <br />

```{r echo=FALSE, results='asis'}
  
# Provide definitions of any failed tests

if(nrow(QA_results$df) > 0){
  
  cat("### Explanation of Test Results", 
        "\n", "\n")
  
  report_warnings <- filter(warnings, title %in% QA_results$df$test)
  
  for(i in 1:nrow(report_warnings)){
    warning <- report_warnings[i,]
    
    cat("####", warning$title, 
        "\n",
        warning$message, "\n", "\n")
    
  }
  
  
}



```

  <br />
  <br />
